<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kip Online Maker</title>
  <style>
    @font-face {
      font-family: 'Pixeled';
      src: url('Pixeled.ttf') format('truetype');
    }

    body {
      font-family: 'Pixeled', sans-serif;
      background-color: #1e1e1e;
      color: #fef4b8;
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: 20px;
    }

    #admin-login {
      margin-bottom: 20px;
    }

    #admin-login input,
    #admin-login button {
      padding: 5px;
      margin: 5px 0;
      background-color: #444;
      color: #fef4b8;
      border: 1px solid #666;
      border-radius: 3px;
    }

    .hidden {
      display: none;
    }

    #game-container {
      margin-bottom: 20px;
    }

    iframe {
      border: 2px solid #666;
      border-radius: 5px;
    }

    #universal-search {
      margin: 15px 0;
      text-align: center;
    }

    #search-input {
      width: 300px;
      padding: 8px;
      background-color: #444;
      color: #fef4b8;
      border: 1px solid #666;
      border-radius: 3px;
      margin-bottom: 10px;
    }

    #level-input-container input,
    #level-input-container button {
      padding: 5px;
      margin: 5px 0;
      background-color: #444;
      color: #fef4b8;
      border: 1px solid #666;
      border-radius: 3px;
    }

    #levels-container,
    #comments-container {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 20px;
      background-color: #2d2d2d;
    }

    .level-card {
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 5px;
      background-color: #3a3a3a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .comment {
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 5px;
      background-color: #3a3a3a;
    }

    .delete-btn,
    .delete-level-btn {
      margin-left: 10px;
      color: red;
      cursor: pointer;
    }

    .timestamp {
      font-size: 0.8em;
      color: #888;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>Kip Online Maker</h1>

  <div id="admin-login">
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button id="login-btn" onclick="login()">Login</button>
    <button id="logout-btn" class="hidden" onclick="logout()">Logout</button>
  </div>

  <div id="universal-search">
    <input type="text" id="search-input" 
           placeholder="Search messages and levels..."
           oninput="filterContent(this.value)">
  </div>

  <div id="game-container">
    <iframe frameborder="0" src="https://itch.io/embed-upload/13098567?color=fef4b8" allowfullscreen="" width="720" height="500"></iframe>
  </div>

  <div id="level-input-container">
    <input type="text" id="level-input" placeholder="Enter level code..." />
    <button onclick="addLevel()">Add Level</button>
  </div>

  <div id="levels-container"></div>
  <div id="comments-container"></div>

  <script>
    const ws = new WebSocket(window.location.origin.replace('http', 'ws'));
    let isAdmin = false;
    const levels = JSON.parse(localStorage.getItem('levels')) || [];
    const deletedMessages = new Set(JSON.parse(localStorage.getItem('deletedMessages')) || []);
    const deletedLevels = new Set(JSON.parse(localStorage.getItem('deletedLevels')) || []);

    function initAdminUI() {
      document.getElementById('login-btn').classList.toggle('hidden', isAdmin);
      document.getElementById('logout-btn').classList.toggle('hidden', !isAdmin);
      document.querySelectorAll('.delete-level-btn, .delete-btn').forEach(btn => {
        btn.style.display = isAdmin ? 'inline-block' : 'none';
      });
    }

    function login() {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;
      if (user === 'Admin' && pass === '1622005') {
        isAdmin = true;
        initAdminUI();
        renderLevels();
      }
    }

    function logout() {
      isAdmin = false;
      initAdminUI();
      renderLevels();
    }

    function addLevel() {
      const levelInput = document.getElementById('level-input');
      const levelCode = levelInput.value.trim();
      if (levelCode) {
        const levelId = Date.now();
        levels.push({ id: levelId, name: levelCode });
        localStorage.setItem('levels', JSON.stringify(levels));
        renderLevels();
        levelInput.value = '';
        ws.send(JSON.stringify({ 
          type: 'new_level', 
          level: { id: levelId, name: levelCode }
        }));
      }
    }

    function deleteLevel(levelId) {
      const index = levels.findIndex(l => l.id === levelId);
      if (index !== -1) {
        levels.splice(index, 1);
        localStorage.setItem('levels', JSON.stringify(levels));
        deletedLevels.add(levelId);
        localStorage.setItem('deletedLevels', JSON.stringify([...deletedLevels]));
        renderLevels();
        ws.send(JSON.stringify({ type: 'delete_level', levelId }));
      }
    }

    function renderLevels() {
      const container = document.getElementById('levels-container');
      const sortedLevels = [...levels]
        .filter(level => !deletedLevels.has(level.id))
        .sort((a, b) => a.name.localeCompare(b.name));

      container.innerHTML = sortedLevels
        .map(level => `
          <div class="level-card" data-id="${level.id}">
            <div>${level.name}</div>
            ${isAdmin ? `<button class="delete-level-btn" onclick="deleteLevel(${level.id})">Delete</button>` : ''}
          </div>
        `).join('');

      const currentSearch = document.getElementById('search-input').value;
      filterContent(currentSearch);
    }

    function filterContent(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      
      // Filter comments
      document.querySelectorAll('.comment').forEach(comment => {
        const content = comment.querySelector('.content').textContent.toLowerCase();
        comment.style.display = content.includes(term) ? 'block' : 'none';
      });

      // Filter levels
      document.querySelectorAll('.level-card').forEach(level => {
        const name = level.querySelector('div').textContent.toLowerCase().trim();
        level.style.display = name.includes(term) ? 'flex' : 'none';
      });
    }

    function handleMessage(message) {
      if (deletedMessages.has(message.id)) return;
      
      const comment = document.createElement('div');
      comment.className = 'comment';
      comment.setAttribute('data-id', message.id);
      comment.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="content">${message.content}</div>
          <small class="timestamp">${new Date(message.timestamp).toLocaleTimeString()}</small>
          ${isAdmin ? `<div class="delete-btn" onclick="deleteComment('${message.id}')">üóëÔ∏è</div>` : ''}
        </div>
      `;
      
      const container = document.getElementById('comments-container');
      container.prepend(comment);
      
      const currentSearch = document.getElementById('search-input').value;
      filterContent(currentSearch);
    }

    function deleteComment(messageId) {
      deletedMessages.add(messageId);
      localStorage.setItem('deletedMessages', JSON.stringify([...deletedMessages]));
      document.querySelector(`.comment[data-id="${messageId}"]`)?.remove();
      ws.send(JSON.stringify({ type: 'delete_message', messageId }));
    }

    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      console.log('[WS IN] Received:', message);
      
      switch (message.type) {
        case 'init':
          levels.push(...message.levels.filter(l => !deletedLevels.has(l.id)));
          renderLevels();
          message.messages.forEach(handleMessage);
          break;
        case 'comment':
          handleMessage(message);
          break;
        case 'delete_level':
          deletedLevels.add(message.levelId);
          renderLevels();
          break;
        case 'delete_message':
          deletedMessages.add(message.messageId);
          document.querySelector(`.comment[data-id="${message.messageId}"]`)?.remove();
          break;
      }
    };

    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://turbowarp.org') return;
      ws.send(JSON.stringify({
        type: 'comment',
        content: event.data,
        id: Date.now(),
        timestamp: Date.now()
      }));
    });

    initAdminUI();
    renderLevels();
  </script>
</body>
</html>