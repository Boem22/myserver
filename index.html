<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kip Online Maker</title>
  <style>
    /* Your existing CSS styles */
  </style>
</head>
<body>
  <h1>Kip Online Maker</h1>

  <!-- Admin Login -->
  <div id="admin-login">
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button id="login-btn" onclick="login()">Login</button>
    <button id="logout-btn" class="hidden" onclick="logout()">Logout</button>
  </div>

  <!-- Game Embed -->
  <div id="game-container">
    <iframe frameborder="0" src="https://itch.io/embed-upload/13098567?color=fef4b8" allowfullscreen="" width="720" height="500"></iframe>
  </div>

  <!-- Level Input -->
  <div id="level-input-container">
    <input type="text" id="level-input" placeholder="Enter level code..." />
    <button onclick="addLevel()">Add Level</button>
  </div>

  <!-- Levels Container -->
  <div id="levels-container"></div>

  <!-- Comments Container -->
  <div id="comments-container"></div>

  <script>
    console.log('Site opened by a user.');
    const ws = new WebSocket('wss://myserver-1jxx.onrender.com');

    // Persistent storage
    let levels = JSON.parse(localStorage.getItem('levels')) || [];
    let levelVotes = JSON.parse(localStorage.getItem('levelVotes')) || {};
    let userVotes = JSON.parse(localStorage.getItem('userVotes')) || {};
    let deletedMessages = new Set(JSON.parse(localStorage.getItem('deletedMessages')) || []);
    let deletedLevels = new Set(JSON.parse(localStorage.getItem('deletedLevels')) || []);
    let isAdmin = false;

    function initAdminUI() {
      const elements = {
        loginBtn: document.getElementById('login-btn'),
        logoutBtn: document.getElementById('logout-btn')
      };

      if (isAdmin) {
        elements.loginBtn.classList.add('hidden');
        elements.logoutBtn.classList.remove('hidden');
      } else {
        elements.loginBtn.classList.remove('hidden');
        elements.logoutBtn.classList.add('hidden');
      }

      // Update delete buttons for all messages
      updateDeleteButtons();
    }

    function updateDeleteButtons() {
      const comments = document.querySelectorAll('.comment');
      comments.forEach(comment => {
        const deleteBtn = comment.querySelector('.delete-btn');
        if (isAdmin) {
          if (!deleteBtn) {
            const deleteButton = document.createElement('div');
            deleteButton.className = 'delete-btn';
            deleteButton.textContent = 'ğŸ—‘ï¸';
            deleteButton.onclick = () => deleteComment(deleteButton, comment.getAttribute('data-id'));
            comment.querySelector('div').appendChild(deleteButton);
          }
        } else {
          if (deleteBtn) deleteBtn.remove();
        }
      });
    }

    function login() {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;
      if (user === 'Admin' && pass === '1622005') {
        isAdmin = true;
        initAdminUI();
      }
    }

    function logout() {
      isAdmin = false;
      initAdminUI();
    }

    function addLevel() {
      const levelInput = document.getElementById('level-input');
      const levelCode = levelInput.value.trim();
      if (levelCode) {
        const levelId = Date.now();
        levels.push({ id: levelId, name: levelCode });
        levelVotes[levelId] = { up: 0, down: 0 };
        localStorage.setItem('levels', JSON.stringify(levels));
        localStorage.setItem('levelVotes', JSON.stringify(levelVotes));
        renderLevels();
        levelInput.value = '';

        ws.send(JSON.stringify({
          type: 'new_level',
          level: { id: levelId, name: levelCode }
        }));
      }
    }

    function deleteLevel(levelId) {
      levels = levels.filter(level => level.id !== levelId);
      delete levelVotes[levelId];
      localStorage.setItem('levels', JSON.stringify(levels));
      localStorage.setItem('levelVotes', JSON.stringify(levelVotes));
      renderLevels();

      deletedLevels.add(levelId);
      localStorage.setItem('deletedLevels', JSON.stringify([...deletedLevels]));

      ws.send(JSON.stringify({
        type: 'delete_level',
        levelId: levelId
      }));
    }

    function voteLevel(levelId, value) {
      if (userVotes[levelId]) return alert('You have already voted!');
      levelVotes[levelId][value === 1 ? 'up' : 'down']++;
      userVotes[levelId] = true;
      localStorage.setItem('levelVotes', JSON.stringify(levelVotes));
      localStorage.setItem('userVotes', JSON.stringify(userVotes));
      renderLevels();

      // Send vote to server
      ws.send(JSON.stringify({
        type: 'vote_level',
        levelId: levelId,
        value: value
      }));
    }

    function renderLevels() {
      const container = document.getElementById('levels-container');
      container.innerHTML = levels
        .filter(level => !deletedLevels.has(level.id))
        .map(level => {
          const votes = levelVotes[level.id] || { up: 0, down: 0 };
          return `
            <div class="level-card">
              <div>${level.name}</div>
              <div class="vote-container">
                <button onclick="voteLevel(${level.id}, 1)" ${userVotes[level.id] ? 'disabled' : ''}>ğŸ‘ ${votes.up}</button>
                <button onclick="voteLevel(${level.id}, -1)" ${userVotes[level.id] ? 'disabled' : ''}>ğŸ‘ ${votes.down}</button>
                ${isAdmin ? `<div class="delete-level-btn" onclick="deleteLevel(${level.id})">ğŸ—‘ï¸</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
    }

    function handleMessage(message) {
      if (deletedMessages.has(message.id)) return;
      
      const container = document.getElementById('comments-container');
      const comment = document.createElement('div');
      comment.className = 'comment';
      comment.setAttribute('data-id', message.id);
      comment.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="content">${message.content}</div>
          <small class="timestamp">${message.time || ''}</small>
          ${isAdmin ? `<div class="delete-btn" onclick="deleteComment(this, '${message.id}')">ğŸ—‘ï¸</div>` : ''}
        </div>
        <div class="vote-container">
          <button onclick="voteComment(this, '${message.id}', 1)">ğŸ‘ ${message.upvotes || 0}</button>
          <button onclick="voteComment(this, '${message.id}', -1)">ğŸ‘ ${message.downvotes || 0}</button>
        </div>
      `;
      container.prepend(comment);
    }

    function deleteComment(element, messageId) {
      deletedMessages.add(messageId);
      localStorage.setItem('deletedMessages', JSON.stringify([...deletedMessages]));
      element.closest('.comment').remove();
      ws.send(JSON.stringify({ type: 'delete_message', messageId: messageId }));
    }

    function voteComment(button, messageId, value) {
      if (userVotes[messageId]) return alert('You have already voted!');
      const voteContainer = button.parentElement;
      const upButton = voteContainer.querySelector('button:first-child');
      const downButton = voteContainer.querySelector('button:last-child');

      if (value === 1) {
        const upCount = parseInt(upButton.textContent.match(/\d+/)[0]) + 1;
        upButton.textContent = `ğŸ‘ ${upCount}`;
      } else {
        const downCount = parseInt(downButton.textContent.match(/\d+/)[0]) + 1;
        downButton.textContent = `ğŸ‘ ${downCount}`;
      }

      userVotes[messageId] = true;
      localStorage.setItem('userVotes', JSON.stringify(userVotes));

      ws.send(JSON.stringify({
        type: 'vote_comment',
        messageId: messageId,
        value: value
      }));
    }

    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      message.time = message.timestamp ? 
        new Date(message.timestamp).toLocaleTimeString() : '';

      switch(message.type) {
        case 'init':
          levels = message.levels.filter(l => !deletedLevels.has(l.id));
          levelVotes = message.levelVotes || {};
          userVotes = message.userVotes || {};
          localStorage.setItem('levels', JSON.stringify(levels));
          localStorage.setItem('levelVotes', JSON.stringify(levelVotes));
          localStorage.setItem('userVotes', JSON.stringify(userVotes));
          renderLevels();
          message.messages.forEach(handleMessage);
          break;
          
        case 'new_level':
          if (!levels.some(l => l.id === message.level.id)) {
            levels.push(message.level);
            levelVotes[message.level.id] = { up: 0, down: 0 };
            localStorage.setItem('levels', JSON.stringify(levels));
            localStorage.setItem('levelVotes', JSON.stringify(levelVotes));
            renderLevels();
          }
          break;
          
        case 'vote_level':
          levelVotes[message.levelId] = levelVotes[message.levelId] || { up: 0, down: 0 };
          levelVotes[message.levelId][message.value === 1 ? 'up' : 'down']++;
          localStorage.setItem('levelVotes', JSON.stringify(levelVotes));
          renderLevels();
          break;
          
        case 'vote_comment':
          const comment = document.querySelector(`.comment[data-id="${message.messageId}"]`);
          if (comment) {
            const upButton = comment.querySelector('.vote-container button:first-child');
            const downButton = comment.querySelector('.vote-container button:last-child');
            if (message.value === 1) {
              const upCount = parseInt(upButton.textContent.match(/\d+/)[0]) + 1;
              upButton.textContent = `ğŸ‘ ${upCount}`;
            } else {
              const downCount = parseInt(downButton.textContent.match(/\d+/)[0]) + 1;
              downButton.textContent = `ğŸ‘ ${downCount}`;
            }
          }
          break;
          
        case 'comment':
          handleMessage(message);
          break;
          
        case 'delete_message':
          deletedMessages.add(message.messageId);
          document.querySelector(`.comment[data-id="${message.messageId}"]`)?.remove();
          break;
          
        case 'delete_level':
          deletedLevels.add(message.levelId);
          levels = levels.filter(l => l.id !== message.levelId);
          renderLevels();
          break;
      }
    };

    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://turbowarp.org') return;
      ws.send(JSON.stringify({
        type: 'comment',
        content: event.data,
        id: Date.now().toString(),
        timestamp: Date.now(),
        upvotes: 0,
        downvotes: 0
      }));
    });

    initAdminUI();
    renderLevels();
  </script>
</body>
</html>