<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kip Online Maker</title>
  <style>
    /* Your existing CSS styles */
    .hidden { display: none; }
    .level-card, .comment {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
    }
    .vote-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .delete-level-btn, .delete-btn {
      cursor: pointer;
      color: red;
    }
  </style>
</head>
<body>
  <h1>Kip Online Maker</h1>

  <!-- Admin Login -->
  <div id="admin-login">
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button id="login-btn" onclick="login()">Login</button>
    <button id="logout-btn" class="hidden" onclick="logout()">Logout</button>
  </div>

  <!-- Game Embed -->
  <div id="game-container">
    <iframe frameborder="0" src="https://itch.io/embed-upload/13098567?color=fef4b8" allowfullscreen="" width="720" height="500"></iframe>
  </div>

  <!-- Level Input -->
  <div id="level-input-container">
    <input type="text" id="level-input" placeholder="Enter level code..." />
    <button onclick="addLevel()">Add Level</button>
  </div>

  <!-- Levels Container -->
  <div id="levels-container"></div>

  <!-- Comments Container -->
  <div id="comments-container"></div>

  <script>
    const ws = new WebSocket('wss://myserver-1jxx.onrender.com');
    let isAdmin = false;

    // Load data from localStorage
    const levels = JSON.parse(localStorage.getItem('levels')) || [];
    const levelVotes = JSON.parse(localStorage.getItem('levelVotes')) || {};
    const userVotes = JSON.parse(localStorage.getItem('userVotes')) || {};
    const deletedMessages = new Set(JSON.parse(localStorage.getItem('deletedMessages')) || []);
    const deletedLevels = new Set(JSON.parse(localStorage.getItem('deletedLevels')) || []);

    function logMessage(direction, message) {
      console.log(`[${direction}]`, message);
    }

    function initAdminUI() {
      document.getElementById('login-btn').classList.toggle('hidden', isAdmin);
      document.getElementById('logout-btn').classList.toggle('hidden', !isAdmin);
      updateDeleteButtons();
      renderLevels();
    }

    function updateDeleteButtons() {
      document.querySelectorAll('.level-card').forEach(levelCard => {
        const deleteBtn = levelCard.querySelector('.delete-level-btn');
        if (isAdmin && !deleteBtn) {
          const deleteButton = document.createElement('div');
          deleteButton.className = 'delete-level-btn';
          deleteButton.textContent = '🗑️';
          deleteButton.onclick = () => deleteLevel(Number(levelCard.getAttribute('data-id')));
          levelCard.querySelector('.vote-container').appendChild(deleteButton);
        } else if (!isAdmin && deleteBtn) {
          deleteBtn.remove();
        }
      });

      document.querySelectorAll('.comment').forEach(comment => {
        const deleteBtn = comment.querySelector('.delete-btn');
        if (isAdmin && !deleteBtn) {
          const deleteButton = document.createElement('div');
          deleteButton.className = 'delete-btn';
          deleteButton.textContent = '🗑️';
          deleteButton.onclick = () => deleteComment(deleteButton, comment.getAttribute('data-id'));
          comment.querySelector('div').appendChild(deleteButton);
        } else if (!isAdmin && deleteBtn) {
          deleteBtn.remove();
        }
      });
    }

    function login() {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;
      if (user === 'Admin' && pass === '1622005') {
        isAdmin = true;
        initAdminUI();
      }
    }

    function logout() {
      isAdmin = false;
      initAdminUI();
    }

    function addLevel() {
      const levelInput = document.getElementById('level-input');
      const levelCode = levelInput.value.trim();
      if (levelCode) {
        const levelId = Date.now();
        levels.push({ id: levelId, name: levelCode });
        levelVotes[levelId] = { up: 0, down: 0 };
        saveData('levels', levels);
        saveData('levelVotes', levelVotes);
        renderLevels();
        levelInput.value = '';

        const message = {
          type: 'new_level',
          level: { id: levelId, name: levelCode }
        };
        ws.send(JSON.stringify(message));
        logMessage('SENT', message);
      }
    }

    function deleteLevel(levelId) {
      const levelIndex = levels.findIndex(l => l.id === levelId);
      if (levelIndex !== -1) {
        levels.splice(levelIndex, 1);
      }

      delete levelVotes[levelId];
      saveData('levels', levels);
      saveData('levelVotes', levelVotes);

      deletedLevels.add(levelId);
      saveData('deletedLevels', [...deletedLevels]);

      document.querySelector(`.level-card[data-id="${levelId}"]`)?.remove();

      const message = { type: 'delete_level', levelId };
      ws.send(JSON.stringify(message));
      logMessage('SENT', message);
    }

    function voteLevel(levelId, value) {
      if (userVotes[levelId]) return alert('You have already voted!');
      levelVotes[levelId][value === 1 ? 'up' : 'down']++;
      userVotes[levelId] = true;
      saveData('levelVotes', levelVotes);
      saveData('userVotes', userVotes);
      renderLevels();

      const message = { type: 'vote_level', levelId, value };
      ws.send(JSON.stringify(message));
      logMessage('SENT', message);
    }

    function renderLevels() {
      const container = document.getElementById('levels-container');
      container.innerHTML = '';

      levels
        .filter(level => !deletedLevels.has(level.id))
        .forEach(level => {
          const votes = levelVotes[level.id] || { up: 0, down: 0 };
          const levelCard = document.createElement('div');
          levelCard.className = 'level-card';
          levelCard.setAttribute('data-id', level.id);
          levelCard.innerHTML = `
            <div>${level.name}</div>
            <div class="vote-container">
              <button onclick="voteLevel(${level.id}, 1)" ${userVotes[level.id] ? 'disabled' : ''}>👍 ${votes.up}</button>
              <button onclick="voteLevel(${level.id}, -1)" ${userVotes[level.id] ? 'disabled' : ''}>👎 ${votes.down}</button>
              ${isAdmin ? `<div class="delete-level-btn" onclick="deleteLevel(${level.id})">🗑️</div>` : ''}
            </div>
          `;
          container.appendChild(levelCard);
        });
    }

    // ... (rest of the comment handling code remains the same)

    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      logMessage('RECEIVED', message);

      message.time = message.timestamp ? new Date(message.timestamp).toLocaleTimeString() : '';

      switch (message.type) {
        case 'init':
          levels.push(...message.levels.filter(l => !deletedLevels.has(l.id)));
          Object.assign(levelVotes, message.levelVotes || {});
          Object.assign(userVotes, message.userVotes || {});
          saveData('levels', levels);
          saveData('levelVotes', levelVotes);
          saveData('userVotes', userVotes);
          renderLevels();
          message.messages.forEach(handleMessage);
          break;

        case 'delete_level':
          deletedLevels.add(message.levelId);
          const index = levels.findIndex(l => l.id === message.levelId);
          if (index !== -1) {
            levels.splice(index, 1);
          }
          renderLevels();
          break;

        // ... (rest of the WebSocket handler cases remain the same)
      }
    };

    // Initial render
    initAdminUI();
    renderLevels();
  </script>
</body>
</html>